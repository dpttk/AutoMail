---
- hosts: all

  vars:
    email: test@example.com
    domain: example.com
    collector_name: user
    password: password

  tasks:
  - name: Update and upgrade apt packages
    become: true
    apt:
      upgrade: yes
      update_cache: yes
      cache_valid_time: 86400 #One day

  - name: Install apache and php.
    become: yes
    apt: 
      name: 
        - apache2
        - php 
        - libapache2-mod-php
        - php-mysql
        - snapd
      state: latest

  - name: Allow apache in ufw.
    become: yes
    community.general.ufw: 
      rule: allow
      name: Apache

  - name: install certbot
    become: yes
    community.general.snap: 
      name: certbot
      classic: true

  - name: Get certificate
    command: sudo certbot certonly --standalone --email {{email}} --domain {{ domain }} --agree-tos --non-interactive
    args:
      creates: /etc/letsencrypt/live/{{ domain }}
    ignore_errors: true # for testing on vm without public ip

    
  - name: Setup cronjob for renewal
    cron:
      name: certbot-renewal
      job: "/bin/bash -lc 'certbot -q renew'"
      minute: "0"
      hour: "14"

  - name: Install postfix, dovecot, roundcube
    become: yes
    apt: 
      name: 
        - postfix
        - dovecot-core
        - dovecot-imapd
        - dovecot-pop3d
        - dovecot-lmtpd
        - roundcube-sqlite3
      state: latest


  - name: Add collector to postfix
    become: yes
    ansible.builtin.lineinfile:
      path: /etc/postfix/virtual_aliases
      state: present
      create: true
      line: '@{{domain}}       {{collector_name}}@{{domain}}'

  - name: Setup postfix/main.cf
    become: yes
    ansible.builtin.template: 
      src: ./templates/main.cf.j2
      dest: /etc/postfix/main.cf

  - name: Adjust postfix/master.cf
    become: yes
    ansible.builtin.replace:
      path: /etc/postfix/master.cf
      regexp: "#submission inet n       -       y       -       -       smtpd" 
      replace: "submission inet n       -       y       -       -       smtpd"

  - name: dovecot/conf.d/10-mail.conf
    become: yes
    ansible.builtin.replace:
      path: /etc/dovecot/conf.d/10-mail.conf
      regexp: "mail_location = mbox:~/mail:INBOX=/var/mail/%u"
      replace: " mail_location = maildir:/var/mail/vhosts/%d/%n"

  - name: vhost directory
    become: yes
    ansible.builtin.file:
      path: /var/mail/vhosts/{{domain}}
      state: directory

  - name: Create vmail group
    become: yes
    ansible.builtin.group:
      name: vmail
      gid: 5000 
      state: present
  
  - name: Create vmail user
    become: yes
    ansible.builtin.user:
      name: vmail
      group: vmail
      uid: 5000
      home: /var/mail/vhosts/
      system: true
      state: present

  - name: Assigning ownership of vhost directory
    become: yes
    ansible.builtin.file:
      path: /var/mail/vhosts/
      group: vmail

  - name: Configure dovecot
    become: yes
    ansible.builtin.template:
      src: "{{item.src}}"
      dest: "{{item.dest}}"
    loop:
      - src: ./templates/10-master.conf.j2
        dest: /etc/dovecot/conf.d/10-master.conf
      - src: ./templates/10-auth.conf.j2
        dest: /etc/dovecot/conf.d/10-auth.conf
      - src: ./templates/auth-passwdfile.conf.ext.j2
        dest: /etc/dovecot/conf.d/auth-passwdfile.conf.ext
      - src: ./templates/dovecot-users.j2
        dest: /etc/dovecot/dovecot-users

  # - name: Still Configure SSL
  #   become: yes
  #   ansible.builtin.replace:
  #     path: /etc/dovecot/conf.d/10-ssl.conf
      